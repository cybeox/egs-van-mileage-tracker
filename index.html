<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Van Mileage Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-right: 1px solid #e9ecef;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #666;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .records-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            font-weight: 600;
            text-align: left;
        }

        .records-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .header h1 {
                font-size: 2rem;
            }

            .records-table {
                font-size: 14px;
            }

            .records-table th,
            .records-table td {
                padding: 8px 5px;
            }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöê Van Mileage Tracker</h1>
            <p>Professional Fleet Management System</p>
            <span id="connectionStatus" class="connection-status disconnected">Not Connected to Google Sheets</span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('entry')">üìù Entry</button>
            <button class="tab" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('records')">üìã Records</button>
            <button class="tab" onclick="showTab('reports')">üìÑ Reports</button>
        </div>

        <div class="content">
            <!-- Entry Tab -->
            <div id="entryTab" class="tab-content">
                <h2>Daily Mileage Entry</h2>
                <div id="alertContainer"></div>
                
                <form id="mileageForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="driver">Driver Name:</label>
                            <select id="driver" required>
                                <option value="">Select Driver</option>
                                <option value="Ijaz">Ijaz</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newDriver">Add New Driver:</label>
                        <input type="text" id="newDriver" placeholder="Enter new driver name">
                        <button type="button" class="btn btn-secondary" onclick="addDriver()">Add Driver</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startPoint">Start Point:</label>
                            <input type="text" id="startPoint" placeholder="e.g., Company HQ" required>
                        </div>
                        <div class="form-group">
                            <label for="startMileage">Start Mileage:</label>
                            <input type="number" id="startMileage" step="0.1" placeholder="e.g., 45230.5" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="destination">Destination:</label>
                            <input type="text" id="destination" placeholder="e.g., Client Site A" required>
                        </div>
                        <div class="form-group">
                            <label for="endPoint">End Point:</label>
                            <input type="text" id="endPoint" placeholder="e.g., Company HQ" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="endMileage">End Mileage:</label>
                            <input type="number" id="endMileage" step="0.1" placeholder="e.g., 45295.3" required>
                        </div>
                        <div class="form-group">
                            <label for="fuelPrice">Fuel Price Today (¬£):</label>
                            <input type="number" id="fuelPrice" step="0.01" placeholder="e.g., 25.50">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="totalMileage">Total Mileage (Auto-calculated):</label>
                        <input type="number" id="totalMileage" step="0.1" readonly style="background: #f8f9fa;">
                    </div>

                    <button type="submit" class="btn">üíæ Save Entry</button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
                </form>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content" style="display: none;">
                <h2>Dashboard Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todayMiles">0</div>
                        <div class="stat-label">Today's Miles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weeklyMiles">0</div>
                        <div class="stat-label">Weekly Miles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthlyMiles">0</div>
                        <div class="stat-label">Monthly Miles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="yearlyMiles">0</div>
                        <div class="stat-label">Yearly Miles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weeklyFuel">¬£0</div>
                        <div class="stat-label">Weekly Fuel Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEntries">0</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Weekly Mileage Trend</h3>
                    <canvas id="mileageChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Fuel Cost Trend</h3>
                    <canvas id="fuelChart"></canvas>
                </div>
            </div>

            <!-- Records Tab -->
            <div id="recordsTab" class="tab-content" style="display: none;">
                <h2>Mileage Records</h2>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="filterDriver">Filter by Driver:</label>
                        <select id="filterDriver">
                            <option value="">All Drivers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterStartDate">From Date:</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="form-group">
                        <label for="filterEndDate">To Date:</label>
                        <input type="date" id="filterEndDate">
                    </div>
                </div>

                <button class="btn" onclick="applyFilters()">üîç Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">‚ùå Clear Filters</button>

                <table class="records-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Driver</th>
                            <th>Start Point</th>
                            <th>Destination</th>
                            <th>End Point</th>
                            <th>Start Miles</th>
                            <th>End Miles</th>
                            <th>Total Miles</th>
                            <th>Fuel Cost</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                    </tbody>
                </table>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content" style="display: none;">
                <h2>Export Reports</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportStartDate">Report Start Date:</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label for="reportEndDate">Report End Date:</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>

                <div class="form-group">
                    <label for="reportDriver">Driver:</label>
                    <select id="reportDriver">
                        <option value="">All Drivers</option>
                    </select>
                </div>

                <div class="form-group">
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Export to Excel</button>
                    <button class="btn btn-success" onclick="exportToPDF()">üìÑ Export to PDF</button>
                    <button class="btn" onclick="syncWithGoogleSheets()">‚òÅÔ∏è Sync with Google Sheets</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="reportTotalMiles">0</div>
                        <div class="stat-label">Total Miles (Report Period)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="reportTotalFuel">¬£0</div>
                        <div class="stat-label">Total Fuel Cost (Report Period)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="reportAvgDaily">0</div>
                        <div class="stat-label">Average Daily Miles</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mileageData = JSON.parse(localStorage.getItem('mileageData')) || [];
        let drivers = JSON.parse(localStorage.getItem('drivers')) || ['Ijaz'];
        let mileageChart = null;
        let fuelChart = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // Update driver dropdowns
            updateDriverDropdowns();
            
            // Load dashboard data
            updateDashboard();
            
            // Load records
            loadRecords();
            
            // Auto-calculate total mileage
            document.getElementById('startMileage').addEventListener('input', calculateTotalMileage);
            document.getElementById('endMileage').addEventListener('input', calculateTotalMileage);
            
            // Form submission
            document.getElementById('mileageForm').addEventListener('submit', handleFormSubmit);
        });

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load tab-specific content
            if (tabName === 'dashboard') {
                updateDashboard();
                setTimeout(createCharts, 100);
            } else if (tabName === 'records') {
                loadRecords();
            }
        }

        // Driver management
        function addDriver() {
            const newDriverName = document.getElementById('newDriver').value.trim();
            if (newDriverName && !drivers.includes(newDriverName)) {
                drivers.push(newDriverName);
                localStorage.setItem('drivers', JSON.stringify(drivers));
                updateDriverDropdowns();
                document.getElementById('newDriver').value = '';
                showAlert('Driver added successfully!', 'success');
            }
        }

        function updateDriverDropdowns() {
            const driverSelects = ['driver', 'filterDriver', 'reportDriver'];
            driverSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = selectId === 'driver' ? '<option value="">Select Driver</option>' : '<option value="">All Drivers</option>';
                
                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver;
                    option.textContent = driver;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // Calculate total mileage
        function calculateTotalMileage() {
            const startMileage = parseFloat(document.getElementById('startMileage').value) || 0;
            const endMileage = parseFloat(document.getElementById('endMileage').value) || 0;
            const totalMileage = endMileage - startMileage;
            document.getElementById('totalMileage').value = totalMileage >= 0 ? totalMileage.toFixed(1) : '';
        }

        // Form handling
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(),
                date: document.getElementById('date').value,
                driver: document.getElementById('driver').value,
                startPoint: document.getElementById('startPoint').value,
                destination: document.getElementById('destination').value,
                endPoint: document.getElementById('endPoint').value,
                startMileage: parseFloat(document.getElementById('startMileage').value),
                endMileage: parseFloat(document.getElementById('endMileage').value),
                totalMileage: parseFloat(document.getElementById('totalMileage').value),
                fuelPrice: parseFloat(document.getElementById('fuelPrice').value) || 0
            };
            
            // Validation
            if (formData.totalMileage < 0) {
                showAlert('End mileage cannot be less than start mileage!', 'error');
                return;
            }
            
            mileageData.push(formData);
            localStorage.setItem('mileageData', JSON.stringify(mileageData));
            
            showAlert('Entry saved successfully!', 'success');
            clearForm();
            updateDashboard();
        }

        function clearForm() {
            document.getElementById('mileageForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('totalMileage').value = '';
        }

        // Dashboard functions
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const weekStart = getWeekStart(new Date());
            const monthStart = new Date().toISOString().slice(0, 7) + '-01';
            const yearStart = new Date().getFullYear() + '-01-01';
            
            const todayMiles = getTotalMiles(data => data.date === today);
            const weeklyMiles = getTotalMiles(data => data.date >= weekStart && data.date <= today);
            const monthlyMiles = getTotalMiles(data => data.date >= monthStart);
            const yearlyMiles = getTotalMiles(data => data.date >= yearStart);
            const weeklyFuel = getTotalFuel(data => data.date >= weekStart && data.date <= today);
            
            document.getElementById('todayMiles').textContent = todayMiles.toFixed(1);
            document.getElementById('weeklyMiles').textContent = weeklyMiles.toFixed(1);
            document.getElementById('monthlyMiles').textContent = monthlyMiles.toFixed(1);
            document.getElementById('yearlyMiles').textContent = yearlyMiles.toFixed(1);
            document.getElementById('weeklyFuel').textContent = '¬£' + weeklyFuel.toFixed(2);
            document.getElementById('totalEntries').textContent = mileageData.length;
        }

        function getTotalMiles(filterFn) {
            return mileageData.filter(filterFn).reduce((total, entry) => total + entry.totalMileage, 0);
        }

        function getTotalFuel(filterFn) {
            return mileageData.filter(filterFn).reduce((total, entry) => total + entry.fuelPrice, 0);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff)).toISOString().split('T')[0];
        }

        // Chart creation
        function createCharts() {
            createMileageChart();
            createFuelChart();
        }

        function createMileageChart() {
            const ctx = document.getElementById('mileageChart').getContext('2d');
            
            if (mileageChart) {
                mileageChart.destroy();
            }
            
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyMiles = last7Days.map(date => {
                return mileageData
                    .filter(entry => entry.date === date)
                    .reduce((total, entry) => total + entry.totalMileage, 0);
            });
            
            mileageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Daily Miles',
                        data: dailyMiles,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createFuelChart() {
            const ctx = document.getElementById('fuelChart').getContext('2d');
            
            if (fuelChart) {
                fuelChart.destroy();
            }
            
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyFuel = last7Days.map(date => {
                return mileageData
                    .filter(entry => entry.date === date)
                    .reduce((total, entry) => total + entry.fuelPrice, 0);
            });
            
            fuelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Daily Fuel Cost (¬£)',
                        data: dailyFuel,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Records management
        function loadRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            const sortedData = [...mileageData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                    <td>${entry.driver}</td>
                    <td>${entry.startPoint}</td>
                    <td>${entry.destination}</td>
                    <td>${entry.endPoint}</td>
                    <td>${entry.startMileage}</td>
                    <td>${entry.endMileage}</td>
                    <td>${entry.totalMileage.toFixed(1)}</td>
                    <td>¬£${entry.fuelPrice.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button></td>
                `;
            });
        }

        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                mileageData = mileageData.filter(entry => entry.id !== id);
                localStorage.setItem('mileageData', JSON.stringify(mileageData));
                loadRecords();
                updateDashboard();
                showAlert('Entry deleted successfully!', 'success');
            }
        }

        // Filtering
        function applyFilters() {
            const filterDriver = document.getElementById('filterDriver').value;
            const filterStartDate = document.getElementById('filterStartDate').value;
            const filterEndDate = document.getElementById('filterEndDate').value;
            
            let filteredData = mileageData;
            
            if (filterDriver) {
                filteredData = filteredData.filter(entry => entry.driver === filterDriver);
            }
            
            if (filterStartDate) {
                filteredData = filteredData.filter(entry => entry.date >= filterStartDate);
            }
            
            if (filterEndDate) {
                filteredData = filteredData.filter(entry => entry.date <= filterEndDate);
            }
            
            displayFilteredRecords(filteredData);
        }

        function clearFilters() {
            document.getElementById('filterDriver').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            loadRecords();
        }

        function displayFilteredRecords(data) {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                    <td>${entry.driver}</td>
                    <td>${entry.startPoint}</td>
                    <td>${entry.destination}</td>
                    <td>${entry.endPoint}</td>
                    <td>${entry.startMileage}</td>
                    <td>${entry.endMileage}</td>
                    <td>${entry.totalMileage.toFixed(1)}</td>
                    <td>¬£${entry.fuelPrice.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button></td>
                `;
            });
        }

        // Export functions
        function exportToExcel() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const driver = document.getElementById('reportDriver').value;
            
            let exportData = getReportData(startDate, endDate, driver);
            updateReportStats(exportData);
            
            // Prepare data for Excel
            const worksheet = [
                ['Van Mileage Report'],
                ['Generated:', new Date().toLocaleDateString()],
                ['Period:', startDate || 'All time', 'to', endDate || 'Present'],
                ['Driver:', driver || 'All drivers'],
                [''],
                ['Date', 'Driver', 'Start Point', 'Destination', 'End Point', 'Start Mileage', 'End Mileage', 'Total Miles', 'Fuel Cost (¬£)']
            ];
            
            exportData.forEach(entry => {
                worksheet.push([
                    entry.date,
                    entry.driver,
                    entry.startPoint,
                    entry.destination,
                    entry.endPoint,
                    entry.startMileage,
                    entry.endMileage,
                    entry.totalMileage,
                    entry.fuelPrice
                ]);
            });
            
            // Add summary
            const totalMiles = exportData.reduce((sum, entry) => sum + entry.totalMileage, 0);
            const totalFuel = exportData.reduce((sum, entry) => sum + entry.fuelPrice, 0);
            
            worksheet.push(['']);
            worksheet.push(['Summary']);
            worksheet.push(['Total Miles:', totalMiles.toFixed(1)]);
            worksheet.push(['Total Fuel Cost:', '¬£' + totalFuel.toFixed(2)]);
            worksheet.push(['Average per day:', (totalMiles / Math.max(exportData.length, 1)).toFixed(1)]);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheet);
            XLSX.utils.book_append_sheet(wb, ws, 'Mileage Report');
            
            // Download
            const filename = `van_mileage_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showAlert('Excel report exported successfully!', 'success');
        }

        function exportToPDF() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const driver = document.getElementById('reportDriver').value;
            
            let exportData = getReportData(startDate, endDate, driver);
            updateReportStats(exportData);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Van Mileage Report', 20, 20);
            
            // Report details
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 35);
            doc.text(`Period: ${startDate || 'All time'} to ${endDate || 'Present'}`, 20, 45);
            doc.text(`Driver: ${driver || 'All drivers'}`, 20, 55);
            
            // Summary stats
            const totalMiles = exportData.reduce((sum, entry) => sum + entry.totalMileage, 0);
            const totalFuel = exportData.reduce((sum, entry) => sum + entry.fuelPrice, 0);
            
            doc.text(`Total Miles: ${totalMiles.toFixed(1)}`, 20, 70);
            doc.text(`Total Fuel Cost: ¬£${totalFuel.toFixed(2)}`, 20, 80);
            doc.text(`Total Entries: ${exportData.length}`, 20, 90);
            
            // Table headers
            let yPos = 110;
            doc.setFontSize(10);
            doc.text('Date', 20, yPos);
            doc.text('Driver', 45, yPos);
            doc.text('Start', 70, yPos);
            doc.text('Destination', 95, yPos);
            doc.text('End', 130, yPos);
            doc.text('Miles', 155, yPos);
            doc.text('Fuel', 175, yPos);
            
            yPos += 10;
            
            // Table data
            exportData.slice(0, 20).forEach(entry => { // Limit to 20 entries for PDF
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.text(entry.date, 20, yPos);
                doc.text(entry.driver.substring(0, 8), 45, yPos);
                doc.text(entry.startPoint.substring(0, 10), 70, yPos);
                doc.text(entry.destination.substring(0, 12), 95, yPos);
                doc.text(entry.endPoint.substring(0, 10), 130, yPos);
                doc.text(entry.totalMileage.toFixed(1), 155, yPos);
                doc.text('¬£' + entry.fuelPrice.toFixed(2), 175, yPos);
                
                yPos += 8;
            });
            
            if (exportData.length > 20) {
                doc.text(`... and ${exportData.length - 20} more entries`, 20, yPos + 10);
            }
            
            const filename = `van_mileage_report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            
            showAlert('PDF report exported successfully!', 'success');
        }

        function getReportData(startDate, endDate, driver) {
            let data = mileageData;
            
            if (driver) {
                data = data.filter(entry => entry.driver === driver);
            }
            
            if (startDate) {
                data = data.filter(entry => entry.date >= startDate);
            }
            
            if (endDate) {
                data = data.filter(entry => entry.date <= endDate);
            }
            
            return data.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function updateReportStats(data) {
            const totalMiles = data.reduce((sum, entry) => sum + entry.totalMileage, 0);
            const totalFuel = data.reduce((sum, entry) => sum + entry.fuelPrice, 0);
            const avgDaily = data.length > 0 ? totalMiles / data.length : 0;
            
            document.getElementById('reportTotalMiles').textContent = totalMiles.toFixed(1);
            document.getElementById('reportTotalFuel').textContent = '¬£' + totalFuel.toFixed(2);
            document.getElementById('reportAvgDaily').textContent = avgDaily.toFixed(1);
        }

        // Google Sheets integration placeholder
        function syncWithGoogleSheets() {
            // This is where you would integrate with Google Sheets API
            showAlert('Google Sheets integration not configured yet. See instructions below.', 'error');
        }

        // Utility functions
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Initialize date inputs with reasonable defaults
        function initializeDateInputs() {
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('reportStartDate').value = oneWeekAgo.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        }

        // Call initialization
        setTimeout(initializeDateInputs, 500);
    </script>
</body>
    </html>
